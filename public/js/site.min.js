const socket=io();let sys,locations,assetsByFaction,assetsByLocation,locationsByGroup,locationOptionsByGroup,locationIdsByName,groupIdsByName,assetTemplate,factionTemplate,starTemplate,systemTemplate,sectorTemplate,deepSpaceTemplate,oribitalTemplate,planetTemplate,assetDotTemplate,locationGroupTemplate,locationTemplate,assetFormTemplate;var templatesCloned=!1;socket.on('refresh',refresh);function toRGB(b){const c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(b),d=c?{r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)}:null;return d}function hoverHighlight(b,c,d){b.attr('data-match',c);const h='[data-'+c+'=true]';var k;d&&(k=toRGB(d));b.addClass('-hoverable'),b.hover(function(){$(h).addClass('-hover'),k&&$(h).css('--hover-colour',k.r+', '+k.g+', '+k.b)},function(){$(h).removeClass('-hover'),k&&$(h).css('--hover-colour','var(--colour)')})}function setColour(b,c){const d=toRGB(c);b.css('--colour',d.r+', '+d.g+', '+d.b)}function createSystemAsset(){const b=systemTemplate.clone();return b}function createAssetElement(b){const c=assetTemplate.clone();c.attr('id',b.id);const d=c.find('.asset__callsign');d.val(b.callsign),hoverHighlight(d,'asset-'+b.id,b.faction.colour),c.find('.asset__name').text(b.name);const h=c.find('select.asset__location-select');for(var k in locationOptionsByGroup)h.append(locationOptionsByGroup[k].clone());return h.attr('data-asset',b.id),h.val(b.locationName),c.find('input.asset__current-hp').val(b.currentHp),c.find('input.asset__current-hp').attr('data-asset',b.id),c.find('button.asset__delete').attr('data-asset',b.id),c.find('input.asset__callsign').attr('data-asset',b.id),c.find('.asset__max-hp').text(b.maxHp),c.attr('data-faction',b.faction.colour),setColour(c,b.faction.colour),c}function createFactionElement(b){const c=factionTemplate.clone();c.attr('id',b.colour),setColour(c,b.colour);const d=c.find('.faction__name');return d.text(b.name),hoverHighlight(d,b.colour),c}function createLocationGroupElement(b,c){const d=locationGroupTemplate.clone();d.attr('id',c);const h=d.find('.location-group__name');return h.text(b),hoverHighlight(h,c),d}function createLocationElement(b){const c=locationTemplate.clone();return c.attr('id',locationIdsByName[b.name]),c.text(b.name),hoverHighlight(c,locationIdsByName[b.name]),c}function createStarElement(b){const c=starTemplate.clone();return c.attr('id',b.name),c.attr('data-'+groupIdsByName[b.name],!0),c}function createOrbitalElement(b,c){const d=orbitalTemplate.clone();return d.attr('data-'+locationIdsByName[b.name],!0),d.attr('id',b.name),d.addClass('ring-'+b.ring),d.addClass('count-'+c),d}function createDeepSpaceElement(b){const c=deepSpaceTemplate.clone();return c.attr('id',b.name),c.attr('data-'+groupIdsByName[b.name],!0),c.addClass('slices-'+b.orbitals.length),c}function createSectorElement(b){const c=sectorTemplate.clone();return c.attr('data-'+locationIdsByName[b.name],!0),c.attr('id',b.name),c.addClass('line-'+b.ring),c}function createPlanetElement(b,c){const d=planetTemplate.clone();return b.faction&&(d.attr('data-'+b.faction.colour,!0),setColour(d,b.faction.colour)),d.attr('data-'+locationIdsByName[b.name],!0),d.attr('data-'+groupIdsByName.Planets,!0),assetsByLocation[b.name].forEach(h=>{d.attr('data-asset-'+h.id,!0)}),d.attr('id',b.name),d.addClass('num-'+c),d}function createAssetDotElement(b,c){const d=assetDotTemplate.clone();return d.attr('data-'+b.faction.colour,!0),d.attr('data-asset-'+b.id,!0),d.attr('id',b.id),d.addClass('num-'+c),setColour(d,b.faction.colour),d}function createAssetForm(){const b=assetFormTemplate.clone();b.attr('id','');const c=b.find('select.asset-form__faction-select'),d=b.find('select.asset-form__location-select');for(var h in sys.factions){const m=$('<option/>');m.val(h),m.text(sys.factions[h].name),c.append(m)}for(var k in locationOptionsByGroup)d.append(locationOptionsByGroup[k].clone());return b.submit(function(m){m.preventDefault();const n=$(this).serializeArray().reduce((q,r)=>{return q[r.name]=r.value,q},{});$.post({url:'create',data:JSON.stringify(n),contentType:'application/json'})}),b}function init(b){sys=b,locations=b.allLocations,locationsByGroup={},locationOptionsByGroup={},groupIdsByName={},locationIdsByName={};var c=0;for(var d in locations.forEach((k,m)=>{locationIdsByName[k.name]='location-'+m;var n=groupIdsByName[k.group];if(n){locationsByGroup[n].push(k);const q=$('<option/>');q.val(k.name),q.text(k.name),locationOptionsByGroup[n].append(q)}else{n='lg-'+c,groupIdsByName[k.group]=n,c++,locationsByGroup[n]=[k];const q=$('<optgroup/>'),r=$('<option/>');q.attr('label',k.group),r.val(k.name),r.text(k.name),q.append(r),locationOptionsByGroup[n]=q}}),assetsByFaction={},sys.factions)assetsByFaction[sys.factions[d].colour]=[];for(var h in assetsByLocation={},locations.forEach(k=>{assetsByLocation[k.name]=[]}),sys.assets)sys.assets[h]&&(assetsByFaction[sys.assets[h].faction.colour].push(sys.assets[h]),assetsByLocation[sys.assets[h].locationName].push(sys.assets[h]));templatesCloned||(assetTemplate=$('.asset#template').clone(),factionTemplate=$('.faction#template').clone(),starTemplate=$('.star#template').clone(),systemTemplate=$('.system#template').clone(),orbitalTemplate=$('.orbital#template').clone(),planetTemplate=$('.planet#template').clone(),assetDotTemplate=$('.asset-dot#template').clone(),assetFormTemplate=$('.asset-form#template').clone(),deepSpaceTemplate=$('.deepspace#template').clone(),sectorTemplate=$('.sector#template').clone(),locationTemplate=$('.location#template').clone(),locationGroupTemplate=$('.location-group#template').clone(),templatesCloned=!0)}function render(){const b=createSystemAsset();b.find('.system__name').text(sys.name),sys.stars.forEach(n=>{const q=createStarElement(n);n.orbitals.forEach(r=>{const u=createOrbitalElement(r,assetsByLocation[r.name].length+r.locations.length);var v=0;r.locations.forEach(w=>{const x=createPlanetElement(w,v);u.append(x),v++}),assetsByLocation[r.name].forEach(w=>{const x=createAssetDotElement(w,v);u.append(x),v++}),q.append(u)}),b.find('.system__stars').append(q)}),sys.deepSpaceRegions.forEach((n,q)=>{const r=createDeepSpaceElement(n);n.orbitals.forEach(u=>{const w=createSectorElement(u);var x=0;u.locations.forEach(y=>{const z=createPlanetElement(y,x);w.append(z),x++}),assetsByLocation[u.name].forEach(y=>{const z=createAssetDotElement(y,x);w.append(z),x++}),r.append(w)});var t=$('<div/>');t.addClass('system__sector'),t.addClass('num-'+q),b.find('.system__deep-space').addClass('num-'+sys.deepSpaceRegions.length),t.append(r),b.find('.system__deep-space').append(t)});const c=$('<div class="locations"/>');for(var d in locationsByGroup){const n=createLocationGroupElement(locationsByGroup[d][0].group,d);locationsByGroup[d].forEach((q,r)=>{const t=createLocationElement(q,d+'-'+r);n.find('.location-group__locations').append(t)}),c.append(n)}const h=$('<div class="assets"/>');for(var k in assetsByFaction){const n=createFactionElement(sys.factions[k]);assetsByFaction[k].forEach(q=>{const r=createAssetElement(q);n.find('.faction__assets').append(r)}),h.append(n)}var m=$('<div/>');m.addClass('sidebar'),m.append(c),m.append(h),m.append(createAssetForm()),$('.root').empty(),$('.root').append(b),$('.root').append(m),$('input.asset__current-hp').change(function(){const n=$(this).attr('data-asset'),q=parseInt($(this).val());$.post({url:'damage',data:JSON.stringify({id:n,hp:q}),contentType:'application/json'})}),$('select.asset__location-select').change(function(){const n=$(this).attr('data-asset'),q=$(this).val();$.post({url:'move',data:JSON.stringify({id:n,location:q}),contentType:'application/json'})}),$('button.asset__delete').click(function(){const n=$(this).attr('data-asset');$.post({url:'delete',data:JSON.stringify({id:n}),contentType:'application/json'})}),$('input.asset__callsign').change(function(){const n=$(this).attr('data-asset'),q=$(this).val();$.post({url:'rename',data:JSON.stringify({id:n,callsign:q}),contentType:'application/json'})})}function refresh(b){init(b),render(),console.log('refresh')}function update(){socket.emit('update',sys)}
